<!--"""
Copyright (C) 2017 kanishka-linux kanishka.linux@gmail.com

This file is part of kawaii-player.

kawaii-player is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

kawaii-player is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with kawaii-player.  If not, see <http://www.gnu.org/licenses/>.



"""-->






<!DOCTYPE html>
<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta name="referrer" content="no-referrer">

<div class= "video_section">

<video id="player" width="640" height="480" controls></video>
<br>
<div id="title"></div>
<br>
<div id="buttons_div" class="Buttons">
<button id="play">Play/Pause</button>
<button id="stop">Stop</button>
<button id="loop">Lock</button>
<button id="prev">Prev</button>
<button id="next">Next</button>
<button id="shuffle">Shuffle</button>
<button id="seek10" hidden="hidden">10s+</button>
<button id="seek_10" hidden="hidden">10s-</button>
<button id="seek60" hidden="hidden">60s+</button>
<button id="seek_60" hidden="hidden">60s-</button>
<button id="seek5m" hidden="hidden">5m+</button>
<button id="seek_5m" hidden="hidden">5m-</button>
<button id="vol5" hidden="hidden">vol++</button>
<button id="vol_5" hidden="hidden">vol--</button>
<button id="fullscreen" hidden="hidden">F</button>
<button id="m3u">Get M3U</button>
<button id="remote_btn">Remote Off</button>
<button id="empty_btn">--</button>
<button id="home">Home</button>
<button id="minimal">Options</button>
<button id="nothing">--</button>
<button id="logout">Logout</button>
</div>
<br>
<div id="selection_site" class="site_selection">
<select id="site" onchange="siteChange()"></select>
<select id="opt" onchange="optChange()"></select>
<button id="opt_ok">Go</button>
<input id="type_search" title="Enter Text to Search. Text box can also be used to input text commands to server as follows 1. create_playlist:playlist_name 2. save_playlist:playlist_name 3. torrent:torrent_magnet_or_http link (for adding torrent) 4. torrent:stop 5. torrent:delete" type="search" placeholder="Search Text" onkeypress="return searchFunction(event)" hidden="hidden">

</div>
<br>
<div id="display_option" class="option_display">
<select id="opt_val" onchange="optValChange()" width="100%" hidden="hidden"></select>
<button id="opt_val_ok" hidden="hidden">Go</button>
</div>
<br>
</div>
<br>
<div id="site_option" hidden></div>
<br>
<div class ="pls" contextmenu ="MyMenu">
<ol id="playlist"></ol>
</div>
<menu type="context" id ="MyMenu"> 
	<menu label="Add To Playlist" id ="menu_playlist"> 
		<menuitem label='hello' onclick="menu_clicked(label)"> </menuitem>
		<menuitem label='world' onclick="menu_clicked(label)"> </menuitem>
	</menu>
	<menuitem label='Remove From Playlist' onclick="menu_clicked_remove(label)"></menuitem>
</menu>
<div class="toTop">
<div id="backToTop">Top</div>
</div>
<style>
.selected {font-weight: bold}
div.toTop{position:fixed;bottom: 1em;right: 1em;}
div.video_section{float:left;}
div.video_section.div.site_selection{float:left;}
div.pls{max-width:640px;float:left;}
div.title{max-width:100%;}

.Buttons{max-width:100%;
    margin: 2px;
    padding: 2px;
    float:left;
    
    }

.Buttons button{
    background-color: gray;
    border: none;
    color: white;
    padding:8px;
    text-align: center;
    text-decoration: none;
    float:left;
    width:96px;
}

.Buttons button:hover {
    background-color: #4CAF50;
    color: white;
}

.Buttons button:active {
  background-color: #3e8e41;
  box-shadow: 0 5px #666;
}

.site_selection{max-width:100%;
    margin: 2px;
    padding: 4px;
    float:left;
    }
    



    
.option_display{max-width:100%;
    margin: 2px;
    padding: 2px;
    float:left;}
    


.video_section{max-width:640px;}
.pls ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
    float:left;
    max-width:100%;
}
.pls li {
	max-width: 100;
    padding: 8px;
    margin-bottom: 7px;
   
}
.pls li:hover {
    background-color: yellow;
}


</style>

<script type = 'text/javascript'>
//div.pls{float:right;max-width:400px;}
// globals


//div.video_section{float:left}
//div.video_section.div.site_selection{float:right;}
//div.pls{float:right;max-width:400px;}
//div.title{max-width:640px;}

var _player = document.getElementById("player"),
    _playlist = document.getElementById("playlist"),
    _stop = document.getElementById("stop"),
    _loop = document.getElementById("loop"),
    _next = document.getElementById("next"),
    _play = document.getElementById("play"),
    _title = document.getElementById("title"),
    _shuffle = document.getElementById("shuffle"),
    _m3u = document.getElementById("m3u"),
    _logout = document.getElementById("logout"),
    _home = document.getElementById("home"),
    _remote = document.getElementById("remote_btn"),
    _opt_ok = document.getElementById("opt_ok"),
    _opt_val_ok = document.getElementById("opt_val_ok"),
    _opt_val = document.getElementById("opt_val"),
    _seek_10 = document.getElementById("seek10"),
    _seek_10_ = document.getElementById("seek_10"),
    _seek_60 = document.getElementById("seek60"),
    _seek_60_ = document.getElementById("seek_60"),
    _seek_5m = document.getElementById("seek5m"),
    _seek_5m_ = document.getElementById("seek_5m"),
    _vol_5 = document.getElementById("vol5"),
    _vol_5_ = document.getElementById("vol_5"),
    _fullscreen = document.getElementById("fullscreen"),
    _selection_site = document.getElementById("selection_site"),
    _minimal = document.getElementById("minimal"),
    _display_option = document.getElementById("display_option"),
    _buttons_div = document.getElementById("buttons_div"),
    _empty_btn = document.getElementById("empty_btn"),
    _remote_val = 'off',
    _clicked_index = 0,
    _old_height = '480',
    _playlist_selected_element = "";
    _prev = document.getElementById("prev");

// functions

function menu_clicked(e){
    var playlist = e;
    var pl = _playlist_selected_element;
    console.log(pl.getAttribute('data-mp3'),pl.getAttribute('data-num'),pl.innerHTML);
    var new_url = 'add_to_playlist='+playlist+'&'+pl.innerHTML+'&'+pl.getAttribute('data-mp3');
    console.log(new_url);
    var client = new getRequest();
	client.get(new_url, function(response) {
	console.log(response);
	_title.innerHTML = response;
	})
}

function menu_clicked_remove(e){
	var site_val = document.getElementById("site").value.toLowerCase();
	var opt = document.getElementById("opt").value;
	var pl = _playlist_selected_element;
	if(site_val == 'playlists' && opt != null){
		console.log(site_val,opt)
		var playlist = opt;
		console.log(pl.getAttribute('data-mp3'),pl.getAttribute('data-num'),pl.innerHTML);
		var new_url = 'remove_from_playlist='+playlist+'&'+pl.getAttribute('data-num');
		console.log(new_url);
		var client = new getRequest();
		client.get(new_url, function(response) {
		console.log(response);
		_title.innerHTML = response;
		})
		r = document.getElementById('playlist');
		first = pl.nextSibling;
		var num = parseInt(pl.getAttribute('data-num'));
		r.removeChild(pl);
		while(first){
			first.setAttribute('data-num',num);
			num = num +1;
			first = first.nextSibling;
		}
	}
}

function searchFunction(e){
	if(e.keyCode==13){
		var z = document.getElementById("type_search");
		console.log(z.value);
		
		if (z.value.startsWith("torrent:")){
			new_val = z.value.replace("torrent:","");
			if (new_val.startsWith('http') || new_val.startsWith('magnet')){
				new_url = 'get_torrent=' + btoa(new_val);
				var client = new getRequest();
				client.get(new_url, function(response) {
				console.log(response);
				_title.innerHTML = response;
				})
			}
			else{
				site = document.getElementById("site");
				site_val = site.value.toLowerCase();
				if (site_val == 'torrent'){
					new_val = z.value.replace("torrent:","");
					if (new_val == 'stop'){
						new_url = 'stop_torrent';
						var client = new getRequest();
						client.get(new_url, function(response) {
						console.log(response);
						_title.innerHTML = response;
						})
					}
					else if(new_val == 'delete'){
						option_val = document.getElementById("opt_val");
						console.log(option_val.value);
						if (option_val != null && option_val != ''){
							new_url = 'get_torrent='+btoa('delete&'+option_val.value)
							var client = new getRequest();
							client.get(new_url, function(response) {
							console.log(response);
							_title.innerHTML = response;
						})
						}
					}
				}
			}
			z.value = '';
		}
		else if(z.value.startsWith("create_playlist:")){
			var new_z = z.value.replace("create_playlist:","");
			if (new_z != null){
				var new_url = "create_playlist="+new_z;
				var client = new getRequest();
				client.get(new_url, function(response) {
				console.log(response);
				_title.innerHTML = response;
			})
			}
			z.value = '';
		}
		else if(z.value.startsWith("save_playlist:")){
			var new_z = z.value.replace("save_playlist:","");
			first = _playlist.firstChild;
			var new_url = "save_playlist="+new_z;
			dict = {};
			while(first){
				num = first.getAttribute('data-num');
				data = first.getAttribute('data-mp3');
				title = first.innerHTML;
				dict[num] = {'title':title,'data':data};
				first = first.nextSibling;
			}
			//console.log(JSON.stringify(dict));
			var client = new postRequest();
				client.post(new_url,dict,function(response) {
					console.log(response);
					_title.innerHTML = response;
			})
		}
		else{
			site = document.getElementById("site");
			site_val = site.value;
			st = "site="+site.value.toLowerCase();
			option = document.getElementById("opt");
			opt_val = option.value;
			opt = "&opt="+option.value.toLowerCase();
			srch = "&s="+z.value.replace(" ","+");
			opt = opt.replace(/" "/g,"+")
			console.log(opt);
			srch_val = srch.toLowerCase();
			if (srch_val.indexOf(".m3u") >=0 || srch_val.indexOf(".pls") >=0){
				console.log(srch_val);
			}
			else{
				srch = srch+'.m3u';
			}
			new_url = st+opt+srch;
			console.log(new_url);
			var client = new getRequest();
			client.get(new_url, function(response) {
			m = response.split('\n');
			r = document.getElementById('playlist')
			while(r.firstChild){r.removeChild(r.firstChild);}
			var indx = 1;
			for(i=1;i<m.length-1;i+=2){
				var a = m[i].substring(10,500);
				var b = m[i+1];
				var new_opt = document.createElement('li');
				new_opt.innerHTML = a;
				new_opt.setAttribute('data-mp3',b);
				new_opt.setAttribute('draggable','true');
				new_opt.setAttribute('ondragstart','drag_start(event)');
				new_opt.setAttribute('ondrop','on_drop(event)');
				new_opt.setAttribute('ondragover','drag_over(event)');
				new_opt.setAttribute('ondragend','drag_end(event)');
				new_opt.setAttribute('ondragenter','drag_enter(event)');
				new_opt.setAttribute('ondragleave','drag_leave(event)');
				new_opt.setAttribute('data-num',indx.toString());
				r.appendChild(new_opt);
				indx += 1;
				}
			})
			}
	}
}

function optChange(){
	var x = document.getElementById("opt").value.toLowerCase();
	x = x.replace(/" "/g,"+");
	console.log(x);
	var y = document.getElementById("site").value.toLowerCase();
	if(y.startsWith('playlists')){
		var new_url = 'site='+y+'&opt='+x+'&s=.m3u';
		var client = new getRequest();
		client.get(new_url, function(response) {
		m = response.split('\n');
		r = document.getElementById('playlist')
		while(r.firstChild){r.removeChild(r.firstChild);}
		var indx = 1;
		for(i=1;i<m.length-1;i+=2){
			var a = m[i].substring(10,500);
			var b = m[i+1];
			var new_opt = document.createElement('li');
			new_opt.innerHTML = a;
			new_opt.setAttribute('data-mp3',b);
			new_opt.setAttribute('data-num',indx.toString());
			new_opt.setAttribute('draggable','true');
			new_opt.setAttribute('ondragstart','drag_start(event)');
			new_opt.setAttribute('ondrop','on_drop(event)');
			new_opt.setAttribute('ondragover','drag_over(event)');
			new_opt.setAttribute('ondragend','drag_end(event)');
			new_opt.setAttribute('ondragenter','drag_enter(event)');
			new_opt.setAttribute('ondragleave','drag_leave(event)');
			r.appendChild(new_opt);
			indx += 1;
			}
		})
		_display_option.hidden = "hidden";
		
	}else{
		var z = 'site='+y+'&opt='+x;
		var client = new getRequest();
		client.get(z, function(response) {
		//console.log(response);
		m = response.split('\n');
		//console.log(m);
		r = document.getElementById('opt_val');
		while(r.firstChild){r.removeChild(r.firstChild);}
		for(i=0;i<m.length;i++){
			var new_opt = document.createElement('option');
			var txt = m[i].substring(0,45);
			if (txt){
			new_opt.text = txt;
			new_opt.value = m[i];
			//console.log(i,txt);
			r.appendChild(new_opt);}
		}
		_display_option.hidden = "";
		r.hidden = "";
		_opt_val_ok.hidden = "";
		
		})
	}
}

function drag_start(e){
	console.log(e.target.getAttribute('data-num'));
	e.dataTransfer.effectAllowed='move';
    e.dataTransfer.setData("link", e.target.getAttribute('data-mp3'));
    e.dataTransfer.setData("num", e.target.getAttribute('data-num'));
    e.dataTransfer.setData("text", e.target.innerHTML);
    e.dataTransfer.setData("node", e.target);
    e.dataTransfer.setDragImage(e.target,0,0);
}

function on_drop(e){
	console.log('---on--drop---')
	console.log(e);
	e.preventDefault();
	 var link_ = e.dataTransfer.getData("link");
	 var num_ = e.dataTransfer.getData("num");
	 var text_ = e.dataTransfer.getData("text");
	 var node_ = e.dataTransfer.getData("node");
	// console.log(link_);
	// console.log(num_);
	// console.log(text_);
	var num_target = e.target.getAttribute('data-num');
	 var new_opt = document.createElement('li');
	console.log(node_);
	new_opt.innerHTML = text_;
	new_opt.setAttribute('data-mp3',link_);
	new_opt.setAttribute('draggable','true');
	new_opt.setAttribute('ondragstart','drag_start(event)');
	new_opt.setAttribute('ondrop','on_drop(event)');
	new_opt.setAttribute('ondragover','drag_over(event)');
	new_opt.setAttribute('ondragend','drag_end(event)');
	new_opt.setAttribute('ondragenter','drag_enter(event)');
	new_opt.setAttribute('ondragleave','drag_leave(event)');
	new_opt.setAttribute('data-num',num_target);
	if (parseInt(num_) >= parseInt(num_target)){
		_playlist.insertBefore(new_opt,e.target);
	}
	else{
		if (e.target.nextSibling){
			_playlist.insertBefore(new_opt,e.target.nextSibling);
		}
		else{
			_playlist.appendChild(new_opt);
		}
	}
	first = _playlist.firstChild;
     e.stopPropagation();
     //console.log(e.target);
     indx = 1;
     while(first){
		cnt_indx = first.getAttribute('data-num');
		if(cnt_indx == num_){
			first.setAttribute('data-num','-1');
			first = first.nextSibling;
		}
		else{
			first.setAttribute('data-num',indx.toString());
			first = first.nextSibling;
			indx = indx +1; 
		}
	}
	first = _playlist.firstChild;
	while(first){
		cnt_indx = first.getAttribute('data-num');
		if(cnt_indx == '-1'){
			_playlist.removeChild(first);
			break;
		}
		first = first.nextSibling;
	}
	var site_val = document.getElementById("site").value.toLowerCase();
	var opt = document.getElementById("opt").value;
	if (site_val == 'playlists' && opt != null){
		new_url = 'change_playlist_order='+opt+'&'+num_+'&'+num_target;
		var client = new getRequest(new_url);
		client.get(new_url, function(response) {
		console.log(response);
		_title.innerHTML = response;
		})
	}
}

function drag_over(e){
	//console.log(e.target);
	e.preventDefault();
}

function drag_end(e){
	//console.log(e.target,'---drag--end--');
	e.preventDefault();
}

function drag_enter(e){
	//console.log(e.target,'drag----enter');
	e.preventDefault();
}

function drag_leave(e){
	//console.log(e.target,'drag--leave--');
	e.preventDefault();
}

function onDocReady(){
	var old_var= _remote.innerHTML;
	var x = document.getElementById("site").value;
	console.log(x);
	var y = document.getElementById("site_option");
	var z = y.innerHTML;
	var w = z.split(';');
	console.log(w);
	if (w[0].toLowerCase() == 'remotefield:false'){
		_seek_10.hidden = "hidden";
		_seek_10_.hidden = "hidden";
		_seek_60.hidden = "hidden";
		_seek_60_.hidden = "hidden";
		_seek_5m.hidden = "hidden";
		_seek_5m_.hidden = "hidden";
		_vol_5.hidden = "hidden";
		_vol_5_.hidden = "hidden";
		_fullscreen.hidden = "hidden";
		_remote.hidden = "hidden";
		_empty_btn.hidden = "";
		_empty_btn.innerHTML = "--";
		
	}else if (w[0].toLowerCase() == 'remotefield:true'){
		_remote.hidden = "";
		_empty_btn.hidden = "hidden";
		_empty_btn.innerHTML = "--";
		}
	
	if (w[1].toLowerCase() == 'remotecontrol:false'){
		_remote.innerHTML = 'Remote Off';
		_remote_val = 'off';
		
	}else if (w[1].toLowerCase() == 'remotecontrol:true'){
		_remote.innerHTML = 'Remote On';
		_remote_val = 'on';
		_seek_10.hidden = "";
		_seek_10_.hidden= "";
		_seek_60.hidden = "";
		_seek_60_.hidden = "";
		_seek_5m.hidden = "";
		_seek_5m_.hidden = "";
		_vol_5.hidden = "";
		_vol_5_.hidden = "";
		_fullscreen.hidden = "";
		}
	
	var x = document.getElementById("site").value;
	console.log(x);
	
	var cur_url = window.location.href;
	if (cur_url.indexOf('site=') >= 0){
		var site_split = cur_url.split('&');
		var site_opt = (site_split[0]).split('=')[1];
		x = site_opt;
		document.getElementById("site").value = x;
	}
	if (cur_url.indexOf('opt=') >= 0){
		var opt_split = cur_url.split('&');
		var opt_opt = (opt_split[1]).split('=')[1];
		op = 'opt_opt='+opt_opt
		if (opt_opt.indexOf('%20') >= 0){
			opt_opt = opt_opt.replace('%20',' ')
			}
		console.log(op);
	}
	var a = x.toLowerCase();
	var req = document.getElementById("opt");
	req.innerHTML = "";
	var pls_arr = [];
	for(i=0;i<w.length;i++){
		j = w[i].toLowerCase().split(':')[0];
		m = w[i].split(':');
		if (m[0].toLowerCase() == 'playlists'){
			pls_arr.push(m[1]);
		}
		if(j.indexOf(x) >=0){
			console.log(j);
			k=w[i].split(":");
			l=j.split(":");
			var new_opt = document.createElement("option");
			new_opt.text = k[1].substring(0,45);
			new_opt.value = k[1];
			req.appendChild(new_opt);
			console.log(new_opt.value+' :created');
			}
		}
	var z1 = document.getElementById("opt");
	z1.value = opt_opt;
	var z = document.getElementById("type_search");
	z.hidden = "";
	//_selection_site.hidden = "hidden";
	w = window.innerWidth;
	if(w < 640)
		{_player.width=(w-30).toString();
		_player.height=parseInt((480/640)*w).toString();
		console.log(screen.width);}
	console.log(pls_arr);
	
	
	r = document.getElementById('menu_playlist')
	while(r.firstChild){r.removeChild(r.firstChild);}
	for(i=0;i<pls_arr.length;i+=1){
		var new_opt = document.createElement('menuitem');
		new_opt.setAttribute('label',pls_arr[i]);
		new_opt.setAttribute('onclick','menu_clicked(label)');
		r.appendChild(new_opt);
		}
}

function siteChange(){
	var x = document.getElementById("site").value;
	console.log(x);
	var y = document.getElementById("site_option");
	var z = y.innerHTML;
	var w = z.split(';');
	console.log(w);
	var a = x.toLowerCase();
	var req = document.getElementById("opt");
	req.innerHTML = "";
	for(i=0;i<w.length;i++){
		//console.log(w[i])
		j = w[i].toLowerCase().split(':')[0];
		if(j.indexOf(x) >= 0){
			console.log(j);
			k=w[i].split(":");
			l=j.split(":");
			console.log(l[0].concat(k[1]));
			var new_opt = document.createElement("option");
			new_opt.text = k[1].substring(0,45);
			new_opt.value = k[1];
			req.appendChild(new_opt);
			}
		}
	var z = document.getElementById("type_search");
	z.hidden = "";
}


function optValChange(){
	var x = document.getElementById("site").value.toLowerCase();
	var y = document.getElementById("opt").value.toLowerCase();
	var z = document.getElementById("opt_val").value;
	console.log(z)
	var new_url = 'site='+x+'&opt='+y+'&s='+z+'&exact.m3u';
	var client = new getRequest();
	client.get(new_url, function(response) {
	//console.log(response);
	m = response.split('\n');
	r = document.getElementById('playlist')
	//console.log(m)
	while(r.firstChild){r.removeChild(r.firstChild);}
	var indx = 1;
	for(i=1;i<m.length-1;i+=2){
		var a = m[i].substring(10,500);
		var b = m[i+1];
		var new_opt = document.createElement('li');
		new_opt.innerHTML = a;
		new_opt.setAttribute('data-mp3',b);
		new_opt.setAttribute('data-num',indx.toString());
		new_opt.setAttribute('draggable','true');
		new_opt.setAttribute('ondragstart','drag_start(event)');
		new_opt.setAttribute('ondrop','on_drop(event)');
		new_opt.setAttribute('ondragover','drag_over(event)');
		new_opt.setAttribute('ondragend','drag_end(event)');
		new_opt.setAttribute('ondragenter','drag_enter(event)');
		new_opt.setAttribute('ondragleave','drag_leave(event)');
		new_opt.setAttribute('width','100%');
		r.appendChild(new_opt);
		indx += 1;
		}
	})
	//window.location.href = new_url;
	document.getElementById("type_search").value = ""; 
}

function playlistItemClick(clickedElement,mode) {
    var selected = _playlist.querySelector(".selected");
    console.log(mode)
    if (selected) {
        selected.classList.remove("selected");
    }
    clickedElement.classList.add("selected");
	var new_src = clickedElement.getAttribute("data-mp3");
	var _clicked_num = clickedElement.getAttribute("data-num");
	_title.innerHTML = _clicked_num+" "+clickedElement.innerHTML;
	_clicked_index = parseInt(_clicked_num);
    if (_remote.innerHTML == 'Remote Off'){
		_player.src = new_src;
		_player.play();
	}else{
		
		if (mode == 'nextplay' || mode == 'playlist'){
		new_indx = 'playlist_'+(_clicked_index-1).toString();
		var client = new getRequest();
			client.get(new_indx, function(response) {
			console.log(response);
			})
		
		}else if (mode == 'next' || mode == 'prev'){
			var client = new getRequest();
			if (mode == 'next'){
			client.get('playnext', function(response) {
			console.log(response);
			r = response.split(':')[1];
			gotoChildNode(r);
			})
			}else if (mode == 'prev'){
				client.get('playprev', function(response) {
				console.log(response);
				r = response.split(':')[1];
				gotoChildNode(r);
			})
			} 
		}
		_player.src = new_src
		console.log(new_src)
	}
}

function playNext() {
    var selected = _playlist.querySelector("li.selected");
    console.log(11);
    console.log(selected.innerHTML,selected.getAttribute('data-mp3'));
    if (_remote_val == 'on'){_clicked_index = _clicked_index + 1}
    if (selected && selected.nextSibling) {
		if (_loop.innerHTML == '\u21BA'){
			playlistItemClick(selected,'nextplay');
			//_title.innerHTML = selected.innerHTML;
		}
		else{
			playlistItemClick(selected.nextSibling,'nextplay');
			//_title.innerHTML = selected.nextSibling.innerHTML;
		}
    }else{
		var first = _playlist.firstChild;
		console.log(first);
		playlistItemClick(first,'nextplay');
		//_title.innerHTML = first.innerHTML;
		}
	
}

_shuffle.addEventListener("click", function () {
	var new_url = 'stream_shuffle.m3u';
	var x = document.getElementById("site").value.toLowerCase();
	var srch_txt = document.getElementById("type_search").value.toLowerCase();
    if (x != 'select'){
		var y = document.getElementById("opt").value.toLowerCase();
		var z = document.getElementById("opt_val").value.toLowerCase();
		if (srch_txt){z=srch_txt;}
		if (x == 'playlists'){ z = "#";}
		if (z){
			if (z=='#'){z="";}
			var new_url = 'site='+x+'&opt='+y+'&s='+z+'&shuffle.m3u';
		
		} else {
			var y = window.location.href;
			y = y.replace(".htm","");
			new_url = 'stream_shuffle.m3u';
		}
	}
	var client = new getRequest();
	client.get(new_url, function(response) {
	console.log(response);
	
	m = response.split('\n');
	r = document.getElementById('playlist')
	console.log(m)
	while(r.firstChild){r.removeChild(r.firstChild);}
	var indx = 1;
	for(i=1;i<m.length-1;i+=2){
		var a = m[i].substring(10,100);
		var b = m[i+1];
		var new_opt = document.createElement('li');
		new_opt.innerHTML = a;
		new_opt.setAttribute('data-mp3',b);
		new_opt.setAttribute('data-num',indx.toString());
		new_opt.setAttribute('draggable','true');
		new_opt.setAttribute('ondragstart','drag_start(event)');
		new_opt.setAttribute('ondrop','on_drop(event)');
		new_opt.setAttribute('ondragover','drag_over(event)');
		new_opt.setAttribute('ondragend','drag_end(event)');
		new_opt.setAttribute('ondragenter','drag_enter(event)');
		new_opt.setAttribute('ondragleave','drag_leave(event)');
		r.appendChild(new_opt);
		indx += 1;
		}
	})
	
	
});

_m3u.addEventListener("click", function () {
	
	var srch_txt = document.getElementById("type_search").value.toLowerCase();
    var x = document.getElementById("site").value.toLowerCase();
    if (x == 'select'){
		var y = window.location.href;
		y = y.replace(".htm","");
		y = y +'.m3u';
		window.location.href = y;
		}
    else{
		var y = document.getElementById("opt").value.toLowerCase();
		var z = document.getElementById("opt_val").value.toLowerCase();
		if (srch_txt){z = srch_txt;}
			
		if (z){
		var new_url = 'site='+x+'&opt='+y+'&s='+z+'.m3u';
		} else {
			var y = window.location.href;
			y = y.replace(".htm","");
			new_url = y +'.m3u';
		}
		window.location.href = new_url;
	}
});

_remote.addEventListener("click", function () {
	
	var old_var= _remote.innerHTML;
    if (old_var == 'Remote Off'){
			_remote.innerHTML = 'Remote On';
			_remote_val = 'on'
			var client = new getRequest();
			client.get('remote_on.htm', function(response) {
			console.log(response);
			_seek_10.hidden = "";
			_seek_10_.hidden= "";
			_seek_60.hidden = "";
			_seek_60_.hidden = "";
			_seek_5m.hidden = "";
			_seek_5m_.hidden = "";
			_vol_5.hidden = "";
			_vol_5_.hidden = "";
			_fullscreen.hidden = "";
	})
		}
	else {
		_remote.innerHTML = 'Remote Off';
		_remote_val = 'off'
		var client = new getRequest();
			client.get('remote_off.htm', function(response) {
			console.log(response);
			_seek_10.hidden = "hidden";
			_seek_10_.hidden = "hidden";
			_seek_60.hidden = "hidden";
			_seek_60_.hidden = "hidden";
			_seek_5m.hidden = "hidden";
			_seek_5m_.hidden = "hidden";
			_vol_5.hidden = "hidden";
			_vol_5_.hidden = "hidden";
			_fullscreen.hidden = "hidden";
	})
	}
});

_home.addEventListener("click", function () {
    window.location.href = 'stream_continue.htm';
});

_logout.addEventListener("click", function () {
    window.location.href = 'logout';
});

_stop.addEventListener("click", function () {
	if (_remote_val == 'off'){_player.pause();_player.src = "";}
    else{
    var client = new getRequest();
		client.get('playerstop', function(response) {
			console.log(response);
	})
    
	}
});

_seek_10.addEventListener("click", function () {
	if (_remote_val == 'on'){
	var client = new getRequest();
	client.get('seek10', function(response) {
	console.log(response);
	})}
});

_seek_10_.addEventListener("click", function () {
	if (_remote_val == 'on'){
	var client = new getRequest();
	client.get('seek_10', function(response) {
	console.log(response);
	})}
});

_seek_60.addEventListener("click", function () {
	if (_remote_val == 'on'){
	var client = new getRequest();
	client.get('seek60', function(response) {
	console.log(response);
	})}
});

_seek_60_.addEventListener("click", function () {
	if (_remote_val == 'on'){
	var client = new getRequest();
	client.get('seek_60', function(response) {
	console.log(response);
	})}
});

_seek_5m.addEventListener("click", function () {
	if (_remote_val == 'on'){
	var client = new getRequest();
	client.get('seek5m', function(response) {
	console.log(response);
	})}
});

_seek_5m_.addEventListener("click", function () {
	if (_remote_val == 'on'){
	var client = new getRequest();
	client.get('seek_5m', function(response) {
	console.log(response);
	})}
});


_vol_5.addEventListener("click", function () {
	if (_remote_val == 'on'){
	var client = new getRequest();
	client.get('volume5', function(response) {
	console.log(response);
	})}
});

_vol_5_.addEventListener("click", function () {
	if (_remote_val == 'on'){
	var client = new getRequest();
	client.get('volume_5', function(response) {
	console.log(response);
	})}
});

_fullscreen.addEventListener("click", function () {
	if (_remote_val == 'on'){
	var client = new getRequest();
	client.get('fullscreen', function(response) {
	console.log(response);
	})}
});

_prev.addEventListener("click", function () {
	var selected = _playlist.querySelector("li.selected");
	if (_remote_val == 'on'){_clicked_index = _clicked_index - 1}
    if (selected && selected.previousSibling) {
		playlistItemClick(selected.previousSibling,'prev');
		//_title.innerHTML = selected.previousSibling.innerHTML;
    }
    
});

_next.addEventListener("click", function () {
	var selected = _playlist.querySelector("li.selected");
	if (_remote_val == 'on'){_clicked_index = _clicked_index + 1;}
    if (selected && selected.nextSibling) {
			playlistItemClick(selected.nextSibling,'next');
			//_title.innerHTML = selected.nextSibling.innerHTML;
		} else {
		var first = _playlist.firstChild;
		console.log('----next---');
		console.log(first);
		console.log('----next---');
		playlistItemClick(first,'next');
		//_title.innerHTML = first.innerHTML;
	}
	
});

_play.addEventListener("click", function () {
	var selected = _playlist.querySelector("li.selected");
    
    if (_remote_val == 'on'){
		var client = new getRequest();
		client.get('playpause', function(response) {
			console.log(response);
			r = response.split(':')[1];
			gotoChildNode(r);
	})
	}else{
		if (_player.readyState == 4){
			if (_player.paused){_player.play();}
			else{_player.pause()}
		} else {
			if (selected){playlistItemClick(selected,'play');}
			else{
			var first = _playlist.firstChild;
			console.log(first);
			playlistItemClick(first,'play');
			//_title.innerHTML = first.innerHTML;
			}
			}
		}
});


function gotoChildNode(num){
	var selected = _playlist.querySelector(".selected");
	if (!selected){
		selected = _playlist.firstChild;
	}
	var _data_num_cur = selected.getAttribute('data-num');
	var new_num = (parseInt(num)+1).toString();
	var _next = "";
	var _prev = "";
	if (parseInt(new_num) > parseInt(_data_num_cur)){
		_next = "next";
	}else if (parseInt(new_num) < parseInt(_data_num_cur)) {
		_prev = "prev";
		}
	console.log(new_num,_data_num_cur);
	if(_next || _prev){
		console.log(">>");
		var _pls = selected;
		_data_num = _pls.getAttribute('data-num');
		while((_data_num != new_num) && (_pls != null)){
				if (_next){
					_pls = _pls.nextSibling;
					console.log(">");
				}else if(_prev){
					_pls = _pls.previousSibling;
					console.log("<");
				}
				_data_num = _pls.getAttribute('data-num');
				
		}
		_title.innerHTML = _data_num+' '+ _pls.innerHTML;
		if (selected) {
			selected.classList.remove("selected");
		}
		_pls.classList.add("selected");
	}
}

_loop.addEventListener("click", function () {
    var old_var= _loop.innerHTML;
    if (old_var == 'Lock'){
			_loop.innerHTML = '\u21BA';
		}
	else {
		_loop.innerHTML = 'Lock';
	}
	if (_remote_val == 'on'){
		var client = new getRequest();
		client.get('lock', function(response) {
			console.log(response);
		// do something with response
	})
	}
});

_opt_ok.addEventListener("click", function () {
  optChange();
  document.getElementById("type_search").value = "";  
});

_minimal.addEventListener("click", function () {
	if (_selection_site.hidden){
		_selection_site.hidden="";
		_display_option.hidden="";}
	else{
		_selection_site.hidden="hidden";
		_display_option.hidden="hidden";
		}
});

_opt_val_ok.addEventListener("click", function () {
  optValChange();
  
});

window.onscroll = function () {
    if (pageYOffset >= 200) {
        document.getElementById('backToTop').style.visibility = "visible";
    } else {
 document.getElementById('backToTop').style.visibility = "hidden";
    }
};

document.getElementById('backToTop').onclick = function()
{
    window.scrollTo(0, 0);
};

window.addEventListener("resize", resizeWindowEvent);
_player.addEventListener("ended", playNext);
_playlist.addEventListener("click", function (e) {
    if (e.target && e.target.nodeName === "LI") {
        
        
        if (_remote_val == 'on'){
        var child = e.target
		//while( (child = child.previousSibling) != null ){ 
		//	console.log(i);
		//	i++;
		//}
		//var i = parseInt(child.getAttribute("data-num"))
		//console.log(i);
		//_clicked_index = i;
		}
		playlistItemClick(e.target,'playlist');
		console.log(e.target);
		//_title.innerHTML = e.target.innerHTML;
    }
})

_playlist.addEventListener("contextmenu", function (e) {
    if (e.target && e.target.nodeName === "LI") {
		_playlist_selected_element = e.target;
    }
})

var getRequest = function() {
    this.get = function(url, callbak) {
        var http_req = new XMLHttpRequest();
        http_req.onreadystatechange = function() { 
            if (http_req.readyState == 4 && http_req.status == 200)
                {callbak(http_req.responseText);}
        }

        http_req.open( "GET", url, true );            
        http_req.send( null );
    }
};

var postRequest = function() {
    this.post = function(url, params,callbak) {
        var http_req = new XMLHttpRequest();
        http_req.onreadystatechange = function() { 
            if (http_req.readyState == 4 && http_req.status == 200)
                {callbak(http_req.responseText);}
        }
		//http_req.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        http_req.open( "POST", url, true );            
        http_req.send(JSON.stringify(params));
    }
};

function resizeWindowEvent(){
	w = window.innerWidth;
	if(w < 640)
		{_player.width=(w-30).toString();
		_player.height=parseInt((480/640)*w).toString();
		console.log(screen.width);}
	else {_player.width="640";_player.height="480";}
}



onDocReady();
</script>
</html>
